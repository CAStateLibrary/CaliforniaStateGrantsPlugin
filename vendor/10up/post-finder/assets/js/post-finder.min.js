/*! Post Finder - v0.4.0
 * 
 * Copyright (c) 2020; */
"use strict";!function(a,b,c,d){var e={};"function"!=typeof a.CustomEvent&&(a.CustomEvent=function(a,b){b=b||{bubbles:!1,cancelable:!1,detail:null};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c}),b.postFinder=function(d,f){var g,h,i,j;h="mainTemplate"in e?e.mainTemplate:e.mainTemplate=b("#tmpl-post-finder-main").html(),i="itemTemplate"in e?e.itemTemplate:e.itemTemplate=b("#tmpl-post-finder-item").html(),g={template:h,fieldSelector:"input[type=hidden]",typesfieldSelector:"input#types[type=hidden]",selectSelector:"select",listSelector:".list",searchSelector:".search",resultsSelector:".results",querySelector:"input[type=text]",nonceSelector:"#post_finder_nonce"};var k=this;k.settings={};var l=b(d);k.init=function(){k.settings=b.extend({},g,f),k.$field=l.find(k.settings.fieldSelector),k.$typefield=l.find(k.settings.typesfieldSelector),k.$select=l.find(k.settings.selectSelector),k.$list=l.find(k.settings.listSelector),k.$search=l.find(k.settings.searchSelector),k.$results=k.$search.find(k.settings.resultsSelector),k.$query=k.$search.find(k.settings.querySelector),k.nonce=b(k.settings.nonceSelector).val(),k.$select.on("change",function(){k.addItem(b(this).val(),b("option:selected",this).text(),b("option:selected",this).data("permalink"))}),k.$search.on("click",".button",function(a){a.preventDefault(),k.search(a)}),k.$search.on("keypress",'input[type="text"]',function(a){13===a.which&&(a.preventDefault(),k.search(a))}),k.$list.sortable({placeholder:"placeholder",update:function(){k.serialize()}}),k.$list.on("click",".delete",function(a){a.preventDefault(),k.removeItem(b(this).closest("li").data("id"))}),k.$results.on("click",".add",function(a){a.preventDefault(),j=b(this).closest("li"),k.addItem(j.data("id"),j.find("span").text(),j.data("permalink"))}),k.$list.on("keypress","li input",function(a){13===a.which&&(a.preventDefault(),b(this).trigger("blur"))}),k.$list.on("blur","li input",function(){k.moveItem(b(this).closest("li"),b(this).val())})},k.moveItem=function(a,b){var c,d=k.$list.find("li"),e=d.length;return b>e||b<1?(alert("Please pick a position between 1 and "+e),!1):b-1!==a.index()&&(c=a.clone(),1===b?k.$list.prepend(c):b>1&&b<e?k.$list.find("li").eq(b-1).before(c):b===e&&k.$list.append(c),a.remove(),void k.serialize())},k.addItem=function(a,b,d){var e=c.template(k.settings.template);if(0!==a){if(k.$list.find("li").length>=l.data("limit"))return void alert(POST_FINDER_CONFIG.max_number_allowed);if(k.$list.find('li[data-id="'+a+'"]').length)return void alert(POST_FINDER_CONFIG.already_added);k.$list.append(e({id:a,title:b,editUrl:POST_FINDER_CONFIG.adminurl+"post.php?post="+a+"&action=edit",permalink:d,pos:k.$list.length+1})),k.$list.find(".notice").hide(),k.$select.find('option[value="'+a+'"]').remove(),k.serialize()}},k.removeItem=function(a){k.$list.find('li[data-id="'+a+'"]').remove(),k.serialize(),0===k.$list.find("li").length&&k.$list.find(".notice").show()},k.search=function(a){var d="",e=a.currentTarget.getAttribute("data-page")?Number(a.currentTarget.getAttribute("data-page")):1,f={action:"pf_search_posts",s:k.$query.val(),page:e,_ajax_nonce:k.nonce},g=e+1,h=c.template(i);f=b.extend(f,l.data("args")),k.$search.addClass("loading"),b.ajax(ajaxurl,{type:"POST",data:f,dataType:"json",success:function(a){if(void 0!==a.posts){if(a.posts.length>0){for(var b in a.posts)d+=h(a.posts[b]);a.posts.length===pfPerPage&&(d+='<li class="next">',d+='<a href="#" class="button" data-page="'+g+'">',d+=POST_FINDER_CONFIG.next,d+="</a>",d+="</li>")}else d="<li>"+POST_FINDER_CONFIG.nothing_found+"</li>";k.$search.removeClass("loading"),k.$results.html(d)}}})},k.serialize=function(){var c=[],d=[],e=1;k.$list.find("li").each(function(){b(this).find("input").val(e),c.push(b(this).data("id")),d.push(b(this).data("type")),e++}),k.$field.val(c.join(",")),k.$typefield.val(d.join(",")),b(document).trigger("updatePostfinder",{idField:k.$field,typeField:k.$typefield}),a.dispatchEvent(new CustomEvent("updatePostFinder",{bubbles:!1,detail:{ids:c}}))},k.init()},b.fn.postFinder=function(a){return this.each(function(){if(d===b(this).data("postFinder")){var c=new b.postFinder(this,a);b(this).data("postFinder",c)}})}}(window,jQuery,_);